generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  email      String   @unique
  firstName  String?
  lastName   String?
  image      String?
  supabaseId String   @unique

  // Relations
  collections     Collection[]
  calendarEvents  CalendarEvent[]
  notes           Note[]
  searchHistory   SearchHistory[]
  generatedImages GeneratedImage[]
  conversations   Conversation[]
}

model Collection {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  name      String
  items     Json[] // Array of {id, type, url, thumbnail, title}

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relations
  calendarEvents CalendarEvent[]
  notes          Note[]
  images         GeneratedImage[]

  @@index([userId])
}

model CalendarEvent {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  title     String
  datetime  DateTime
  note      String?
  completed Boolean  @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  linkedCollectionId String?
  linkedCollection   Collection? @relation(fields: [linkedCollectionId], references: [id], onDelete: SetNull)

  linkedItems Json[] // Array of item IDs

  @@index([userId])
  @@index([datetime])
}

model Note {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  content      String
  sourceSearch String?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  linkedCollectionId String?
  linkedCollection   Collection? @relation(fields: [linkedCollectionId], references: [id], onDelete: SetNull)

  @@index([userId])
}

model SearchHistory {
  id           String   @id @default(uuid())
  createdAt    DateTime @default(now())
  query        String
  source       String // "google", "github", "pexels"
  filters      Json?
  resultsCount Int?

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
}

model GeneratedImage {
  id          String   @id @default(uuid())
  createdAt   DateTime @default(now())
  originalUrl String
  variations  Json[] // Array of {url, prompt}

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  linkedCollectionId String?
  linkedCollection   Collection? @relation(fields: [linkedCollectionId], references: [id], onDelete: SetNull)

  @@index([userId])
}

model Conversation {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  threadId  String   @unique
  name      String?
  messages  Json[] // Array of message objects

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([updatedAt])
}
